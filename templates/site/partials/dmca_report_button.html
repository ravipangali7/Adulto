{% load static %}

<!-- Floating DMCA Report Button -->
<div id="dmca-report-button" class="fixed bottom-6 left-6 z-50">
    <button 
        id="open-dmca-modal-btn" 
        class="bg-primary-gold hover:bg-primary-gold-dark text-black rounded-full p-4 shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center group"
        title="Report Copyright Infringement"
        aria-label="Report Copyright Infringement"
    >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg> Report Video
    </button>
</div>

<!-- DMCA Report Modal -->
<div id="dmca-report-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div id="dmca-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-grey-custom rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-grey-custom px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white" id="modal-title">
                        Report Copyright Infringement
                    </h3>
                    <button 
                        id="close-dmca-modal-btn" 
                        class="text-gray-400 hover:text-white transition-colors"
                        aria-label="Close modal"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Form -->
                <form id="dmca-report-form" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="page_url" id="dmca-page-url" value="{{ request.build_absolute_uri }}">
                    
                    <!-- Name Field -->
                    <div>
                        <label for="id_name" class="block text-sm font-medium text-white mb-2">
                            Your Name <span class="text-red-400">*</span>
                        </label>
                        <input 
                            type="text" 
                            name="name" 
                            id="id_name" 
                            required
                            maxlength="150"
                            class="w-full px-4 py-3 bg-bg-grey border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-gold focus:border-transparent"
                            placeholder="Enter your name"
                        >
                        <div id="name-error" class="text-red-400 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Email Field -->
                    <div>
                        <label for="id_email" class="block text-sm font-medium text-white mb-2">
                            Your Email <span class="text-red-400">*</span>
                        </label>
                        <input 
                            type="email" 
                            name="email" 
                            id="id_email" 
                            required
                            class="w-full px-4 py-3 bg-bg-grey border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-gold focus:border-transparent"
                            placeholder="your.email@example.com"
                        >
                        <div id="email-error" class="text-red-400 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Message Field -->
                    <div>
                        <label for="id_message" class="block text-sm font-medium text-white mb-2">
                            Report Details <span class="text-red-400">*</span>
                        </label>
                        <textarea 
                            name="message" 
                            id="id_message" 
                            required
                            rows="6"
                            class="w-full px-4 py-3 bg-bg-grey border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-gold focus:border-transparent resize-none"
                            placeholder="Please provide details about the copyright infringement..."
                        ></textarea>
                        <div id="message-error" class="text-red-400 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Error Message -->
                    <div id="form-error" class="text-red-400 text-sm hidden"></div>

                    <!-- Success Message -->
                    <div id="form-success" class="text-green-400 text-sm hidden"></div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button 
                            type="button" 
                            id="cancel-dmca-btn"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors duration-200"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            id="submit-dmca-btn"
                            class="px-4 py-2 bg-primary-gold hover:bg-primary-gold-dark text-black rounded-lg font-medium transition-colors duration-200"
                        >
                            Submit Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Ensure modal is above everything */
    #dmca-report-modal {
        z-index: 9999;
    }
    
    /* Smooth transitions */
    #dmca-report-modal {
        transition: opacity 0.3s ease-in-out;
    }
    
    #dmca-report-modal.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    #dmca-report-modal:not(.hidden) {
        opacity: 1;
        pointer-events: auto;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('dmca-report-modal');
    const openBtn = document.getElementById('open-dmca-modal-btn');
    const closeBtn = document.getElementById('close-dmca-modal-btn');
    const cancelBtn = document.getElementById('cancel-dmca-btn');
    const overlay = document.getElementById('dmca-modal-overlay');
    const form = document.getElementById('dmca-report-form');
    const submitBtn = document.getElementById('submit-dmca-btn');
    
    // Update page URL when modal opens
    function updatePageUrl() {
        const pageUrlInput = document.getElementById('dmca-page-url');
        if (pageUrlInput) {
            pageUrlInput.value = window.location.href;
        }
    }
    
    // Open modal
    function openModal() {
        updatePageUrl();
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    // Close modal
    function closeModal() {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
        // Reset form
        form.reset();
        // Clear errors
        clearErrors();
    }
    
    // Clear error messages
    function clearErrors() {
        document.querySelectorAll('[id$="-error"]').forEach(el => {
            el.classList.add('hidden');
            el.textContent = '';
        });
        document.getElementById('form-error').classList.add('hidden');
        document.getElementById('form-success').classList.add('hidden');
    }
    
    // Show error for specific field
    function showFieldError(fieldName, message) {
        const errorDiv = document.getElementById(fieldName + '-error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    }
    
    // Show form-level error
    function showFormError(message) {
        const errorDiv = document.getElementById('form-error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }
    
    // Show success message
    function showSuccess(message) {
        const successDiv = document.getElementById('form-success');
        successDiv.textContent = message;
        successDiv.classList.remove('hidden');
    }
    
    // Event listeners
    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Clear previous errors
        clearErrors();
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Get form data
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Submit via AJAX
        fetch('{% url "submit_dmca_report" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showSuccess(data.message);
                
                // Reset form
                form.reset();
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    closeModal();
                }, 2000);
            } else {
                // Show errors
                if (data.errors) {
                    // Field-specific errors
                    Object.keys(data.errors).forEach(field => {
                        showFieldError(field, data.errors[field]);
                    });
                } else {
                    // General error
                    showFormError(data.message || 'An error occurred. Please try again.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFormError('An error occurred while submitting the report. Please try again.');
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Report';
        });
    });
});
</script>
