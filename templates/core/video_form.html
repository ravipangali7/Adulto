{% extends 'core/layout/base.html' %}
{% block content %}
<div class="container-fluid p-0">
    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ title }}</h5>
                </div>
                <div class="card-body">
                    <!-- Display Django messages -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form id="video-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Display form-level errors -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors|join:', ' }}
                            </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="text-danger small">{{ form.title.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Slug</label>
                            {{ form.slug }}
                            <div class="form-text">Auto-generated from title. You can override.</div>
                            {% if form.slug.errors %}
                                <div class="text-danger small">{{ form.slug.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            {{ form.description }}
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Categories</label>
                                    <div class="mb-2">
                                        <input type="text" id="category-search" class="form-control form-control-sm" placeholder="Search categories..." autocomplete="off">
                                    </div>
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-categories">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-categories">
                                            <i class="fas fa-square"></i> Deselect All
                                        </button>
                                    </div>
                                    <div class="border rounded p-3" id="category-container" style="max-height: 200px; overflow-y: auto;">
                                        {% for checkbox in form.category %}
                                            <div class="form-check category-item" data-name="{{ checkbox.choice_label|lower }}">
                                                {{ checkbox.tag }}
                                                <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                    {{ checkbox.choice_label }}
                                                </label>
                                            </div>
                                        {% empty %}
                                            <p class="text-muted">No categories available. <a href="{% url 'category_create' %}">Create one</a></p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <div class="mb-2">
                                        <input type="text" id="tag-search" class="form-control form-control-sm" placeholder="Search tags..." autocomplete="off">
                                    </div>
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-tags">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-tags">
                                            <i class="fas fa-square"></i> Deselect All
                                        </button>
                                    </div>
                                    <div class="border rounded p-3" id="tag-container" style="max-height: 200px; overflow-y: auto;">
                                        {% for checkbox in form.tags %}
                                            <div class="form-check tag-item" data-name="{{ checkbox.choice_label|lower }}">
                                                {{ checkbox.tag }}
                                                <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                    {{ checkbox.choice_label }}
                                                </label>
                                            </div>
                                        {% empty %}
                                            <p class="text-muted">No tags available. <a href="{% url 'tag_create' %}">Create one</a></p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Video File</label>
                                    {{ form.video_file }}
                                    {% if form.video_file.errors %}
                                        <div class="text-danger small">{{ form.video_file.errors|join:', ' }}</div>
                                    {% endif %}
                                    
                                    <!-- File size warning -->
                                    <div class="form-text">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Maximum file size: 300MB. Only MP4 format supported.
                                            {% if form.instance and form.instance.pk %}
                                                <br><i class="fas fa-edit"></i> 
                                                Leave empty to keep current video file.
                                            {% endif %}
                                        </small>
                                    </div>
                                    
                                    <!-- Upload Progress Bar -->
                                    <div id="upload-progress" class="mt-2" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Uploading...</small>
                                            <small id="progress-percentage" class="text-primary fw-bold">0%</small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small id="uploaded-size" class="text-muted">0 MB</small>
                                            <small id="total-size" class="text-muted">0 MB</small>
                                        </div>
                                        <div id="upload-status" class="text-center mt-2">
                                            <small class="text-muted">Preparing upload...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Thumbnail</label>
                                    {{ form.thumbnail }}
                                    <div class="form-text">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Only JPG/JPEG format supported.
                                        </small>
                                    </div>
                                    {% if form.thumbnail.errors %}
                                        <div class="text-danger small">{{ form.thumbnail.errors|join:', ' }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">SEO Title</label>
                            {{ form.seo_title }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">SEO Description</label>
                            {{ form.seo_description }}
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    <strong>Active</strong>
                                    <small class="text-muted d-block">If checked, video will be visible on the public site</small>
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="text-danger small">{{ form.is_active.errors|join:', ' }}</div>
                            {% endif %}
                        </div>
                        <button id="submit-btn" class="btn btn-primary" type="submit">Save Video</button>
                        <a class="btn btn-secondary" href="{% url 'video_list' %}">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Preview</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Selected thumbnail:</p>
                    {% if form.instance and form.instance.thumbnail %}
                        <img src="{{ form.instance.thumbnail.url }}" class="img-fluid rounded"/>
                    {% else %}
                        <div class="text-muted">No thumbnail</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_css %}
<style>
    /* Mobile-friendly progress bar */
    @media (max-width: 768px) {
        #upload-progress {
            margin-top: 1rem;
        }
        
        .progress {
            height: 12px !important;
        }
        
        .progress-bar {
            font-size: 0.75rem;
        }
        
        #upload-progress small {
            font-size: 0.8rem;
        }
        
        #upload-progress .d-flex {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        #upload-progress .d-flex.justify-content-between {
            flex-direction: row;
        }
    }
    
    /* Progress bar animations */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
    
    /* File size warning styling */
    .form-text {
        background-color: #f8f9fa;
        border-left: 3px solid #007bff;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
    
    .form-text i {
        color: #007bff;
        margin-right: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        function slugify(value) {
            return value
                .toString()
                .normalize('NFKD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                .substring(0, 220);
        }
        
        // Auto-generate slug from title
        const titleInput = document.getElementById('id_title');
        const slugInput = document.getElementById('id_slug');
        if (titleInput && slugInput) {
            let userTouchedSlug = false;
            slugInput.addEventListener('input', function() { 
                userTouchedSlug = this.value.length > 0; 
            });
            titleInput.addEventListener('input', function() {
                if (!userTouchedSlug) {
                    slugInput.value = slugify(this.value);
                }
            });
        }

        // Select All / Deselect All functionality for categories and tags
        function setupSelectAllButtons(selectAllId, deselectAllId, checkboxName) {
            const selectAllBtn = document.getElementById(selectAllId);
            const deselectAllBtn = document.getElementById(deselectAllId);
            
            if (selectAllBtn && deselectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll(`input[name="${checkboxName}"]`);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                });
                
                deselectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll(`input[name="${checkboxName}"]`);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                });
            }
        }

        // Initialize select all functionality
        setupSelectAllButtons('select-all-categories', 'deselect-all-categories', 'category');
        setupSelectAllButtons('select-all-tags', 'deselect-all-tags', 'tags');

        // Search functionality for categories and tags
        function setupSearch(searchInputId, containerId, itemClass) {
            const searchInput = document.getElementById(searchInputId);
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll(`.${itemClass}`);
            
            if (searchInput && container && items.length > 0) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    items.forEach(item => {
                        const itemName = item.getAttribute('data-name') || '';
                        const matches = itemName.includes(searchTerm);
                        
                        if (matches || searchTerm === '') {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    
                    // Show "No results" message if no items match
                    const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
                    let noResultsMsg = container.querySelector('.no-results-msg');
                    
                    if (visibleItems.length === 0 && searchTerm !== '') {
                        if (!noResultsMsg) {
                            noResultsMsg = document.createElement('div');
                            noResultsMsg.className = 'no-results-msg text-muted text-center py-3';
                            noResultsMsg.innerHTML = '<i class="fas fa-search me-2"></i>No matching items found';
                            container.appendChild(noResultsMsg);
                        }
                        noResultsMsg.style.display = 'block';
                    } else if (noResultsMsg) {
                        noResultsMsg.style.display = 'none';
                    }
                });
            }
        }
        
        // Initialize search functionality
        setupSearch('category-search', 'category-container', 'category-item');
        setupSearch('tag-search', 'tag-container', 'tag-item');

        // Form validation and progress tracking
        const form = document.getElementById('video-form');
        const submitBtn = document.getElementById('submit-btn');
        const progressContainer = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const uploadedSize = document.getElementById('uploaded-size');
        const totalSize = document.getElementById('total-size');
        const uploadStatus = document.getElementById('upload-status');
        
        form.addEventListener('submit', function(e) {
            const titleField = document.getElementById('id_title');
            const slugField = document.getElementById('id_slug');
            const videoFile = document.getElementById('id_video_file').files[0];
            
            // Check if this is an edit (existing video) or new video
            const isEdit = {{ form.instance.pk|yesno:"true,false" }};
            
            // Basic validation
            if (!titleField.value.trim()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Title Required',
                    text: 'Please enter a video title',
                    confirmButtonColor: '#007bff'
                });
                titleField.focus();
                e.preventDefault();
                return false;
            }
            
            if (!slugField.value.trim()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Slug Required',
                    text: 'Please enter a video slug',
                    confirmButtonColor: '#007bff'
                });
                slugField.focus();
                e.preventDefault();
                return false;
            }
            
            // Only require video file for new videos, not when editing
            if (!isEdit && !videoFile) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No File Selected',
                    text: 'Please select a video file',
                    confirmButtonColor: '#007bff'
                });
                e.preventDefault();
                return false;
            }
            
            // Only validate file size and show progress if a new file is selected
            if (videoFile) {
                // Check file size (300MB limit)
                const maxSize = 300 * 1024 * 1024; // 300MB in bytes
                if (videoFile.size > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'File size too large. Maximum allowed size is 300MB.',
                        confirmButtonColor: '#dc3545'
                    });
                    e.preventDefault();
                    return false;
                }
                
                // Show progress bar for files larger than 10MB
                if (videoFile.size > 10 * 1024 * 1024) {
                    e.preventDefault();
                    uploadWithProgress(videoFile);
                    return false;
                }
                
                // For small files, show simple loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';
            } else if (isEdit) {
                // For edits without new file, show saving state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            }
            
            // Allow normal form submission
            return true;
        });
        
        function uploadWithProgress(videoFile) {
            // Show progress bar
            progressContainer.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            // Update file size info
            const fileSizeMB = (videoFile.size / (1024 * 1024)).toFixed(1);
            totalSize.textContent = fileSizeMB + ' MB';
            uploadedSize.textContent = '0 MB';
            progressPercentage.textContent = '0%';
            uploadStatus.textContent = 'Starting upload...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
            
            // Create FormData
            const formData = new FormData(form);
            
            // Create XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();
            
            // Set timeout for large files (15 minutes)
            xhr.timeout = 15 * 60 * 1000; // 15 minutes
            
            // Timeout handler
            xhr.addEventListener('timeout', function() {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-warning');
                uploadStatus.textContent = 'Upload timeout. The file may be too large or connection is slow.';
                uploadStatus.className = 'text-warning text-center mt-2';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Retry Upload';
            });
            
            // Upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                    progressPercentage.textContent = percentComplete + '%';
                    
                    // Show file size info
                    const loadedMB = (e.loaded / (1024 * 1024)).toFixed(1);
                    uploadedSize.textContent = loadedMB + ' MB';
                    
                    // Update status
                    if (percentComplete < 100) {
                        uploadStatus.textContent = `Uploading... ${percentComplete}% complete`;
                    } else {
                        uploadStatus.textContent = 'Processing video...';
                    }
                }
            });
            
            // Upload complete
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    // Success
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    uploadStatus.textContent = 'Upload completed successfully!';
                    uploadStatus.className = 'text-success text-center mt-2';
                    
                    // Redirect after a short delay
                    setTimeout(function() {
                        window.location.href = '{% url "video_list" %}';
                    }, 2000);
                } else {
                    // Error - show specific error message
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    let errorMessage = 'Upload failed. Please try again.';
                    
                    if (xhr.status === 413) {
                        errorMessage = 'File too large. Maximum size is 1GB.';
                    } else if (xhr.status === 408) {
                        errorMessage = 'Upload timeout. Please try again.';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Server error. Please try again later.';
                    } else if (xhr.status === 0) {
                        errorMessage = 'Connection lost. Please check your internet and try again.';
                    }
                    
                    uploadStatus.textContent = errorMessage;
                    uploadStatus.className = 'text-danger text-center mt-2';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Video';
                }
            });
            
            // Upload error
            xhr.addEventListener('error', function() {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                uploadStatus.textContent = 'Upload failed. Please check your connection.';
                uploadStatus.className = 'text-danger text-center mt-2';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Video';
            });
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                console.error('CSRF token not found');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Video';
                alert('Error: CSRF token not found. Please refresh the page and try again.');
                return;
            }
            
            // Start upload
            xhr.open('POST', form.action || window.location.href);
            xhr.setRequestHeader('X-CSRFToken', csrfToken.value);
            xhr.send(formData);
        }
    })();
</script>
{% endblock %}


