{% extends 'core/layout/base.html' %}
{% block content %}
{% csrf_token %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 d-inline align-middle">Media Library</h1>
        <a href="{% url 'media_library_upload_page' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Video
        </a>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Videos in Media Library</h5>
                </div>
                <div class="card-body">
                    {% if videos %}
                        <div class="row" id="video-grid">
                            {% for video in videos %}
                                <div class="col-md-3 col-sm-6 mb-4" data-filename="{{ video.filename }}">
                                    <div class="card h-100">
                                        <div class="position-relative">
                                            <img src="{% url 'media_library_thumbnail' video.filename %}" 
                                                 class="card-img-top" 
                                                 alt="{{ video.filename }}"
                                                 style="height: 200px; object-fit: cover;"
                                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIFRodW1ibmFpbDwvdGV4dD48L3N2Zz4='">
                                            <div class="position-absolute top-0 end-0 p-2">
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="deleteVideo('{{ video.filename }}')"
                                                        title="Delete Video">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="position-absolute bottom-0 start-0 end-0 p-2 bg-dark bg-opacity-75">
                                                <small class="text-white">
                                                    <i class="fas fa-clock"></i> {{ video.duration|floatformat:0 }}s
                                                </small>
                                            </div>
                                        </div>
                                        <div class="card-body p-2">
                                            <h6 class="card-title text-truncate" title="{{ video.filename }}">
                                                {{ video.filename }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-hdd"></i> {{ video.file_size }} MB
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-video fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No videos in media library</h5>
                            <p class="text-muted">Upload your first video to get started</p>
                            <a href="{% url 'media_library_upload_page' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Video
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
// Simple functions for media library
function deleteVideo(filename) {
    Swal.fire({
        title: 'Delete Video',
        text: `Are you sure you want to delete "${filename}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
        const formData = new FormData();
        formData.append('filename', filename);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'CSRF token not found. Please refresh the page and try again.',
                confirmButtonColor: '#dc3545'
            });
            return;
        }
        
        fetch('{% url "media_library_delete" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken.value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove video card from DOM
                const videoCard = document.querySelector(`[data-filename="${filename}"]`);
                if (videoCard) {
                    videoCard.remove();
                }
                
                // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    });
                
                // If no videos left, show empty state
                const videoGrid = document.getElementById('video-grid');
                if (videoGrid && videoGrid.children.length === 0) {
                    location.reload();
                }
            } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'Unknown error occurred',
                        confirmButtonColor: '#dc3545'
                    });
            }
        })
        .catch(error => {
            console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Error deleting video. Please try again.',
                    confirmButtonColor: '#dc3545'
                        });
                    });
            }
        });
}
</script>
{% endblock %}

