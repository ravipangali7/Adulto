{% extends 'core/layout/base.html' %}
{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 d-inline align-middle">Test Chunked Upload</h1>
        <a class="btn btn-secondary" href="{% url 'video_list' %}">Back to Videos</a>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Test Large File Upload</h5>
                </div>
                <div class="card-body">
                    <form id="test-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">Video File</label>
                            <input type="file" id="test-file-input" class="form-control" accept="video/*" required>
                            <div class="form-text">Select a large video file to test chunked upload</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" id="test-title" class="form-control" value="Test Video" required>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="test-progress" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Uploading...</small>
                                <small id="test-progress-percentage" class="text-primary fw-bold">0%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="test-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small id="test-uploaded-size" class="text-muted">0 MB</small>
                                <small id="test-total-size" class="text-muted">0 MB</small>
                            </div>
                            <div id="test-upload-status" class="text-center mt-2">
                                <small class="text-muted">Preparing upload...</small>
                            </div>
                        </div>
                        
                        <button type="submit" id="test-submit-btn" class="btn btn-primary">Start Test Upload</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const form = document.getElementById('test-form');
    const submitBtn = document.getElementById('test-submit-btn');
    const fileInput = document.getElementById('test-file-input');
    const titleInput = document.getElementById('test-title');
    const progressContainer = document.getElementById('test-progress');
    const progressBar = document.getElementById('test-progress-bar');
    const progressPercentage = document.getElementById('test-progress-percentage');
    const uploadedSize = document.getElementById('test-uploaded-size');
    const totalSize = document.getElementById('test-total-size');
    const uploadStatus = document.getElementById('test-upload-status');
    
    let uploadInProgress = false;
    let currentFile = null;
    let fileId = null;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (uploadInProgress) {
            alert('Upload in progress. Please wait...');
            return false;
        }
        
        if (!fileInput.files[0]) {
            alert('Please select a file');
            return false;
        }
        
        if (!titleInput.value.trim()) {
            alert('Please enter a title');
            return false;
        }
        
        startTestUpload();
    });
    
    function startTestUpload() {
        currentFile = fileInput.files[0];
        fileId = 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Show progress bar
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';
        uploadInProgress = true;
        
        // Update file size info
        const fileSizeMB = (currentFile.size / (1024 * 1024)).toFixed(1);
        totalSize.textContent = fileSizeMB + ' MB';
        uploadedSize.textContent = '0 MB';
        progressPercentage.textContent = '0%';
        uploadStatus.textContent = 'Preparing upload...';
        
        // Reset progress bar
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
        
        // Start uploading chunks
        uploadTestChunks();
    }
    
    function uploadTestChunks() {
        const chunkSize = 1024 * 1024; // 1MB chunks
        const totalChunks = Math.ceil(currentFile.size / chunkSize);
        let uploadedChunks = 0;
        
        uploadStatus.textContent = `Uploading ${totalChunks} chunks...`;
        
        function uploadChunk(chunkIndex) {
            if (chunkIndex >= totalChunks) {
                // All chunks uploaded
                uploadStatus.textContent = 'Finalizing upload...';
                return;
            }
            
            const start = chunkIndex * chunkSize;
            const end = Math.min(start + chunkSize, currentFile.size);
            const chunk = currentFile.slice(start, end);
            
            const formData = new FormData();
            formData.append('chunk', chunk);
            formData.append('chunk_number', chunkIndex);
            formData.append('total_chunks', totalChunks);
            formData.append('file_id', fileId);
            formData.append('file_name', currentFile.name);
            formData.append('file_size', currentFile.size);
            formData.append('title', titleInput.value);
            formData.append('slug', titleInput.value.toLowerCase().replace(/[^a-z0-9]+/g, '-'));
            formData.append('description', 'Test upload');
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "upload_chunk" %}', true);
            xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.status === 'complete') {
                        // Upload completed successfully
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-success');
                        uploadStatus.textContent = 'Upload completed successfully!';
                        uploadStatus.className = 'text-success text-center mt-2';
                        
                        // Reset form
                        setTimeout(function() {
                            form.reset();
                            progressContainer.style.display = 'none';
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Start Test Upload';
                            uploadInProgress = false;
                        }, 3000);
                    } else if (response.status === 'chunk_received') {
                        // Chunk uploaded successfully, continue with next chunk
                        uploadedChunks++;
                        const progress = Math.round((uploadedChunks / totalChunks) * 100);
                        
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);
                        progressPercentage.textContent = progress + '%';
                        
                        const uploadedMB = ((uploadedChunks * chunkSize) / (1024 * 1024)).toFixed(1);
                        uploadedSize.textContent = uploadedMB + ' MB';
                        
                        uploadStatus.textContent = `Uploading chunk ${uploadedChunks + 1} of ${totalChunks}...`;
                        
                        // Upload next chunk
                        setTimeout(() => uploadChunk(chunkIndex + 1), 100);
                    }
                } else {
                    // Error occurred
                    handleTestUploadError('Upload failed. Please try again.');
                }
            };
            
            xhr.onerror = function() {
                handleTestUploadError('Upload failed. Please check your connection.');
            };
            
            xhr.send(formData);
        }
        
        // Start uploading first chunk
        uploadChunk(0);
    }
    
    function handleTestUploadError(message) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        uploadStatus.textContent = message;
        uploadStatus.className = 'text-danger text-center mt-2';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Start Test Upload';
        uploadInProgress = false;
    }
})();
</script>
{% endblock %}
